== TypeScriptで素朴なWebサーバを書こう

わたしが何をしたいかというと、link:https://gihyo.jp/book/2023/978-4-297-13288-0[《改訂３版 JavaScript本格入門》]（山田祥寛 著 2023年2月 技術評論社 刊、以下で「本格本」と略記）の《10.4 非同期通信の基本を理解する - Fetch API》に掲載されたHTTPクライアントとしてのJavaScriptを実行するのに必要なWebサーバを自分で書きたい。Denoで動かしたい。HTTPリクエストのURLとパラメータを解析し適切なファイルを選んで応答できればいい。どういうコードを書けばいいのだろう？元ネタはないかしら？とネットで漁ったら、この記事を見つけた。

- link:https://medium.com/deno-the-complete-reference/native-router-in-deno-16595970daae[Native Router in Deno]

ぴったりだった。この記事もとづきWebサーバを自作した。コードが全部で１５０行程度と短く初心者のわたしでも理解できる。これを以下で説明する。

=== ソースコードのありか

ここで説明するコード一式をGitHubで公開しています。

- link:https://github.com/kazurayam/JavaScriptAtoZ/tree/develop/src/chap10/fetch[src/chap10/fetch]

[source]
----
$ tree .
.
├── app.ts
├── appstart.sh
├── apptest.ipynb
├── book.json
├── ...
├── fetch_basic.html
├── ...
├── index.html
├── native-router
│   └── mod.ts
├── scripts
│   ├── ...
│   ├── fetch_basic.js
----

=== 最初の一歩

VSCodeで `src/chap10/fetch/apptest.ipynb` を開きます。このファイルはJupyterのNotebookファイルです。`Simplest Request and Response` と題したセルを選択し、こういうTypeScriptコードを書いた。

[source]
----
const response = await fetch("http://localhost:3000/hello");
if (response.status === 200) {
    const text = await response.text();
    console.log(text);
} else {
    console.log(response);
}
----

Fetch APIを介して `http://localhost:3000/` にHTTP GETリクエストをあげる。応答を受けとったらHTTPステータスを調べる。ステータスが200正常ならば応答のボディ部分のテキストをconsoleに表示する。ステータスが200正常でなかったらResponseオブジェクトそのままconsoleに表示する。やっていることは以上。CTRLとENTERキーを同時に押して実行してみよう。

image:https://kazurayam.github.io/JavaScriptAtoZ/images/5.1_Simplest_Request_and_Response_failure.png[]

エラーになりました。まだWebサーバを立ち上げていなかったから。では Webサーバを起動しましょう。VSCodeのTerminalウインドウを開き、`src/chap10/fetch` ディレクトリにcdします。そして シェルスクリプト `appstart.sh` を実行します。

[source]
----
$ cd <プロジェクトのディレクトリ>/src/chap10/fetch
$ ./appstart.sh
----

シェルスクリプトの中身は一行だけで、TypeScirpt ファイル `app.ts` を `deno` で実行しています。

[source]
----
include::../src/chap10/fetch/appstart.sh[]
----

image:https://kazurayam.github.io/JavaScriptAtoZ/images/5.2_Simplest_Request_and_Response_success.png[]

今度は、Webサーバが "Hello" と応答してくれました。

Webサーバをどうやって停止するか？ `./appstart.sh` を実行したのと同じTerminalウインドウで CTRLキーとCキーを押下してプロセスをkillします。

=== Webサーバのソースコードを読む

`http://localhost:3000/hello` をGETするHTTPリクエストに応答したのはTypeスクリプト `app.ts` の下記の部分です。

[source]
----
include::../src/chap10/fetch/app.ts[lines=1..17]

include::../src/chap10/fetch/app.ts[lines=54..59]
----

`"/hello"` というURLPatternにマッチするHTTPリクエストがWebサーバに到来したら `Hello` というメッセージを応答する、ただそれだけのことをしています。

=== Deno native-router

`app.ts` は `./native-router/mod.ts` というコードをimportして利用しています。このコードは下記のサイトからダウンロードしました。

- https://deno.land/x/nativerouter@1.0.0

記事 link:https://medium.com/deno-the-complete-reference/native-router-in-deno-16595970daae[Native Router in Deno]が Deno native-routerを 解説しています。わたしはこの記事を読み `./native-router/mod.ts` を利用して `app.ts` を書きました。以下、`app.ts` のコードについて説明していきます。

=== パラメータつきGETリクエストに応答する

- Webサーバ `app.ts` のコード
[source]
----
include::../src/chap10/fetch/app.ts[lines=7..17]
----

Requestのなかに `?name=値` の形で埋め込まれた値を取り出しています。URL文字列を link:https://deno.land/api@v1.39.1?s=URL[`URL`] に変換し、`searchParams` プロパティのなかから `name` プロパティの値を取り出しています。

- クライアント `apptest.ipynb` のコード
[source]
----
const response = await fetch("http://localhost:3000/hello?name=decoy");
if (response.status === 200) {
    const text = await response.text();
    console.log(text);
} else {
    console.log(response);
}
----

- クライアントを実行した結果

[source]
----
Hello, decoy
----

=== パラメータつきPOSTリクエストに応答する

=== URLのPathがパラメータ化されているリクエストに応答する

=== HTMLファイルを応答する

=== JSファイルを応答する

=== JSONファイルを応答する

